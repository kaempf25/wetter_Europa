<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heizlastrechner</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Heizlastrechner</h1>
            <p class="subtitle">Berechne deine Heizlast aus dem tatsächlichen Gasverbrauch und Wetterdaten des DWD</p>
        </header>

        <form id="heizlast-form">
            <div class="form-section">
                <h2>Gebäudedaten</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="plz">Postleitzahl</label>
                        <input type="text" id="plz" name="plz" placeholder="z.B. 70173" maxlength="5" pattern="[0-9]{5}" required>
                        <span class="hint" id="station-hint"></span>
                    </div>
                    <div class="form-group">
                        <label for="wohnflaeche">Wohnfläche (m²)</label>
                        <input type="number" id="wohnflaeche" name="wohnflaeche" placeholder="z.B. 120" min="10" max="2000" required>
                    </div>
                    <div class="form-group">
                        <label for="baujahr">Baujahr</label>
                        <input type="number" id="baujahr" name="baujahr" placeholder="z.B. 1975" min="1800" max="2026" required>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h2>Verbrauchsdaten</h2>
                <p class="info">Gib deinen Gasverbrauch für einen beliebigen Zeitraum ein. Am besten eignen sich kalte Wochen im Winter.</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="datum_von">Von</label>
                        <input type="date" id="datum_von" name="datum_von" required>
                    </div>
                    <div class="form-group">
                        <label for="datum_bis">Bis</label>
                        <input type="date" id="datum_bis" name="datum_bis" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="gasverbrauch">Gasverbrauch</label>
                        <input type="number" id="gasverbrauch" name="gasverbrauch" placeholder="z.B. 1500" min="0" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="einheit">Einheit</label>
                        <select id="einheit" name="einheit">
                            <option value="kwh">kWh</option>
                            <option value="m3">m³ (Gaszähler)</option>
                        </select>
                    </div>
                </div>
            </div>

            <button type="submit" id="submit-btn">Heizlast berechnen</button>
        </form>

        <div id="loading" class="hidden">
            <div class="spinner"></div>
            <p>Wetterdaten werden abgerufen und Heizlast berechnet...</p>
        </div>

        <div id="error" class="hidden">
            <p id="error-text"></p>
        </div>

        <div id="results" class="hidden">
            <h2>Ergebnisse</h2>

            <div class="result-cards">
                <div class="card highlight">
                    <h3>Norm-Heizlast</h3>
                    <div class="value" id="res-heizlast">-</div>
                    <div class="unit">kW</div>
                    <p class="desc">Bei Norm-Außentemperatur <span id="res-norm-temp">-</span>°C</p>
                </div>
                <div class="card">
                    <h3>Spezifische Heizlast</h3>
                    <div class="value" id="res-spezifisch">-</div>
                    <div class="unit">W/m²</div>
                </div>
                <div class="card accent">
                    <h3>Wärmepumpe</h3>
                    <div class="value" id="res-wp">-</div>
                    <div class="unit">kW (empfohlen)</div>
                    <p class="desc">inkl. 10% Sicherheitszuschlag</p>
                </div>
            </div>

            <div class="detail-section">
                <h3>Wetterdaten</h3>
                <table>
                    <tr><td>Wetterstation</td><td id="res-station">-</td></tr>
                    <tr><td>Entfernung</td><td id="res-distance">-</td></tr>
                    <tr><td>Mittlere Außentemperatur</td><td id="res-avg-temp">-</td></tr>
                    <tr><td>Min / Max Temperatur</td><td id="res-minmax-temp">-</td></tr>
                    <tr><td>Ausgewertete Tage</td><td id="res-tage">-</td></tr>
                </table>
            </div>

            <div class="detail-section">
                <h3>Berechnung</h3>
                <table>
                    <tr><td>Heizenergie (abzgl. Warmwasser)</td><td id="res-heizenergie">-</td></tr>
                    <tr><td>Mittlere Heizleistung im Zeitraum</td><td id="res-mittlere-leistung">-</td></tr>
                </table>
            </div>

            <div class="detail-section">
                <h3>Vergleich: Schätzung nach Baujahr</h3>
                <p id="res-schaetzung">-</p>
                <div class="bar-chart" id="bar-chart"></div>
            </div>

            <div class="detail-section">
                <h3>Temperaturverlauf</h3>
                <canvas id="temp-chart" width="700" height="250"></canvas>
            </div>

            <div class="hinweis">
                <h3>Hinweise</h3>
                <ul>
                    <li>Die Berechnung basiert auf der linearen Extrapolation des Verbrauchs auf die Norm-Außentemperatur.</li>
                    <li>Für genauere Ergebnisse solltest du mehrere Zeiträume im Winter auswerten.</li>
                    <li>Der Warmwasseranteil wird pauschal mit 12% angenommen.</li>
                    <li>Bei der Umrechnung von m³ Gas wird ein Brennwert von 11,2 kWh/m³ angenommen.</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // PLZ → Station-Lookup bei Eingabe
        let stationTimeout;
        document.getElementById('plz').addEventListener('input', function() {
            clearTimeout(stationTimeout);
            const plz = this.value.trim();
            const hint = document.getElementById('station-hint');
            if (plz.length === 5) {
                stationTimeout = setTimeout(() => {
                    fetch(`/api/station?plz=${plz}`)
                        .then(r => r.json())
                        .then(data => {
                            if (data.station_name) {
                                hint.textContent = `Wetterstation: ${data.station_name} (${data.distance_km} km)`;
                                hint.className = 'hint success';
                            } else {
                                hint.textContent = data.error || 'Station nicht gefunden';
                                hint.className = 'hint error';
                            }
                        })
                        .catch(() => { hint.textContent = ''; });
                }, 300);
            } else {
                hint.textContent = '';
                hint.className = 'hint';
            }
        });

        // Formular absenden
        document.getElementById('heizlast-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const btn = document.getElementById('submit-btn');
            const loading = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const results = document.getElementById('results');

            btn.disabled = true;
            loading.classList.remove('hidden');
            errorDiv.classList.add('hidden');
            results.classList.add('hidden');

            const payload = {
                plz: document.getElementById('plz').value,
                datum_von: document.getElementById('datum_von').value,
                datum_bis: document.getElementById('datum_bis').value,
                gasverbrauch: parseFloat(document.getElementById('gasverbrauch').value),
                wohnflaeche: parseFloat(document.getElementById('wohnflaeche').value),
                baujahr: parseInt(document.getElementById('baujahr').value),
                einheit: document.getElementById('einheit').value,
            };

            try {
                const resp = await fetch('/api/berechnen', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const data = await resp.json();

                if (data.error) {
                    document.getElementById('error-text').textContent = data.error;
                    errorDiv.classList.remove('hidden');
                } else {
                    displayResults(data);
                    results.classList.remove('hidden');
                }
            } catch (err) {
                document.getElementById('error-text').textContent = 'Verbindungsfehler: ' + err.message;
                errorDiv.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                loading.classList.add('hidden');
            }
        });

        function displayResults(data) {
            document.getElementById('res-heizlast').textContent = data.heizlast_kw;
            document.getElementById('res-norm-temp').textContent = data.norm_aussentemperatur;
            document.getElementById('res-spezifisch').textContent = data.heizlast_spezifisch_w_m2;
            document.getElementById('res-wp').textContent = data.empfehlung_waermepumpe_kw;

            document.getElementById('res-station').textContent = data.station.station_name;
            document.getElementById('res-distance').textContent = data.station.distance_km + ' km';
            document.getElementById('res-avg-temp').textContent = data.temperatur.mittelwert + ' °C';
            document.getElementById('res-minmax-temp').textContent =
                data.temperatur.minimum + ' °C / ' + data.temperatur.maximum + ' °C';
            document.getElementById('res-tage').textContent = data.temperatur.tage + ' Tage';

            document.getElementById('res-heizenergie').textContent = data.heizenergie_kwh + ' kWh';
            document.getElementById('res-mittlere-leistung').textContent = data.mittlere_heizleistung_kw + ' kW';

            // Vergleich Baujahr-Schätzung
            const s = data.schaetzung_baujahr;
            document.getElementById('res-schaetzung').textContent =
                `Typisch für Baujahr ${data.eingaben.baujahr}: ${s.min_kw} - ${s.max_kw} kW ` +
                `(${s.spezifisch_min} - ${s.spezifisch_max} W/m²)`;

            drawBarChart(data);
            drawTempChart(data.daily_temps);
        }

        function drawBarChart(data) {
            const container = document.getElementById('bar-chart');
            container.innerHTML = '';
            const s = data.schaetzung_baujahr;
            const maxVal = Math.max(data.heizlast_kw, s.max_kw) * 1.2;

            const items = [
                { label: 'Berechnet', value: data.heizlast_kw, cls: 'bar-calculated' },
                { label: 'Schätzung Min', value: s.min_kw, cls: 'bar-estimate' },
                { label: 'Schätzung Max', value: s.max_kw, cls: 'bar-estimate' },
                { label: 'WP-Empfehlung', value: data.empfehlung_waermepumpe_kw, cls: 'bar-wp' },
            ];

            items.forEach(item => {
                const row = document.createElement('div');
                row.className = 'bar-row';
                const pct = (item.value / maxVal * 100).toFixed(1);
                row.innerHTML = `
                    <span class="bar-label">${item.label}</span>
                    <div class="bar-track">
                        <div class="bar-fill ${item.cls}" style="width:${pct}%"></div>
                    </div>
                    <span class="bar-value">${item.value} kW</span>
                `;
                container.appendChild(row);
            });
        }

        function drawTempChart(dailyTemps) {
            const canvas = document.getElementById('temp-chart');
            const ctx = canvas.getContext('2d');
            const days = Object.keys(dailyTemps).sort();
            const temps = days.map(d => dailyTemps[d]);

            if (temps.length === 0) return;

            const W = canvas.width;
            const H = canvas.height;
            const pad = { top: 20, right: 20, bottom: 40, left: 50 };
            const plotW = W - pad.left - pad.right;
            const plotH = H - pad.top - pad.bottom;

            const minT = Math.floor(Math.min(...temps) - 2);
            const maxT = Math.ceil(Math.max(...temps) + 2);
            const rangeT = maxT - minT || 1;

            ctx.clearRect(0, 0, W, H);
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(pad.left, pad.top, plotW, plotH);

            // 0°C-Linie
            if (minT <= 0 && maxT >= 0) {
                const y0 = pad.top + plotH - ((0 - minT) / rangeT) * plotH;
                ctx.strokeStyle = '#ddd';
                ctx.lineWidth = 1;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(pad.left, y0);
                ctx.lineTo(pad.left + plotW, y0);
                ctx.stroke();
                ctx.setLineDash([]);
                ctx.fillStyle = '#999';
                ctx.font = '11px sans-serif';
                ctx.fillText('0°C', pad.left - 35, y0 + 4);
            }

            // Y-Achse
            ctx.fillStyle = '#666';
            ctx.font = '11px sans-serif';
            const steps = 5;
            for (let i = 0; i <= steps; i++) {
                const val = minT + (rangeT / steps) * i;
                const y = pad.top + plotH - (i / steps) * plotH;
                ctx.fillText(val.toFixed(0) + '°', pad.left - 35, y + 4);
            }

            // Temperaturlinie
            ctx.strokeStyle = '#2563eb';
            ctx.lineWidth = 2;
            ctx.beginPath();
            temps.forEach((t, i) => {
                const x = pad.left + (i / (temps.length - 1 || 1)) * plotW;
                const y = pad.top + plotH - ((t - minT) / rangeT) * plotH;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();

            // X-Achse Labels
            ctx.fillStyle = '#666';
            ctx.font = '10px sans-serif';
            const labelEvery = Math.max(1, Math.floor(days.length / 6));
            days.forEach((d, i) => {
                if (i % labelEvery === 0 || i === days.length - 1) {
                    const x = pad.left + (i / (days.length - 1 || 1)) * plotW;
                    ctx.save();
                    ctx.translate(x, pad.top + plotH + 10);
                    ctx.rotate(-0.5);
                    ctx.fillText(d.slice(5), 0, 0);
                    ctx.restore();
                }
            });
        }
    </script>
</body>
</html>
